<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Home Harmony{% endblock %} - Smart Cleaning Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
          theme: {
              extend: {
                  colors: {
                      'warm-brown-config': '#A0522D',
                      'light-beige-config': '#F5F5DC',
                      'amber': colors.amber,
                  }
              }
          }
      }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css">

    {% block head_extra %}{% endblock %}

</head>
<body class="beige-bg text-gray-800">

    {% include '_nav.html' %}

    <main>
        {% block content %}
        {% endblock %}
    </main>

    {% include '_footer.html' %}

    {% include '_auth_modal.html' %}
    {% include '_add_funds_modal.html' %}

    <script>
    const authModal = document.getElementById('authModal');
    const loginFormContainer = document.getElementById('loginFormContainer');
    const registerFormContainer = document.getElementById('registerFormContainer');
    const loginErrorDiv = document.getElementById('loginError');
    const registerErrorDiv = document.getElementById('registerError');
    const loginErrorMsg = document.getElementById('loginErrorMsg');
    const registerErrorMsg = document.getElementById('registerErrorMsg');

    function openModal() {
        hideError('login');
        hideError('register');
        authModal.style.display = 'block';
        showLoginForm();
    }

    function closeModal() {
        authModal.style.display = 'none';
    }

    function showRegisterForm() {
        hideError('login');
        loginFormContainer.style.display = 'none';
        registerFormContainer.style.display = 'block';
    }

    function showLoginForm() {
        hideError('register');
        registerFormContainer.style.display = 'none';
        loginFormContainer.style.display = 'block';
    }
    window.onclick = function(event) {
        if (event.target == authModal) {
            closeModal();
        }
    }
    function showError(formType, message) {
        if (formType === 'login') {
            loginErrorMsg.textContent = message || 'An unknown error occurred.';
            loginErrorDiv.style.display = 'block';
        } else if (formType === 'register') {
            registerErrorMsg.textContent = message || 'An unknown error occurred.';
            registerErrorDiv.style.display = 'block';
        }
    }

    function hideError(formType) {
         if (formType === 'login') {
            loginErrorDiv.style.display = 'none';
            loginErrorMsg.textContent = '';
        } else if (formType === 'register') {
            registerErrorDiv.style.display = 'none';
             registerErrorMsg.textContent = '';
        }
    }
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');

    if (loginForm) {
        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            hideError('login');

            const formData = new FormData(loginForm);
            const urlEncodedData = new URLSearchParams();
            for (const pair of formData.entries()) {
                urlEncodedData.append(pair[0], pair[1]);
            }


            try {
                const response = await fetch('/auth/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: urlEncodedData
                });

                if (response.ok) {
                    closeModal();
                    window.location.reload();
                } else {
                    const errorData = await response.json();
                    showError('login', errorData.detail || `Error ${response.status}`);
                }
            } catch (error) {
                console.error('Login Fetch Error:', error);
                showError('login', 'A network error occurred. Please try again.');
            }
        });
    }

    if (registerForm) {
        registerForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            hideError('register');

            const formData = new FormData(registerForm);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('Registration successful! Please log in.');
                    showLoginForm();
                    registerForm.reset();

                } else {
                    const errorData = await response.json();
                    showError('register', errorData.detail || `Error ${response.status}`);
                }
            } catch (error) {
                console.error('Register Fetch Error:', error);
                showError('register', 'A network error occurred. Please try again.');
            }
        });
    }
    const addFundsModal = document.getElementById('addFundsModal');
    const addFundsForm = document.getElementById('addFundsForm');
    const addFundsErrorDiv = document.getElementById('addFundsError');
    const addFundsErrorMsg = document.getElementById('addFundsErrorMsg');
    const addAmountInput = document.getElementById('add-amount');
    const addFundsSubmitBtn = document.getElementById('addFundsSubmitBtn');
    let currentUserIdForFunds = null;

    function openAddFundsModal(userId) {
        if (!addFundsModal) return;
        currentUserIdForFunds = userId;
        hideAddFundsError();
        if(addFundsForm) addFundsForm.reset();
        addFundsModal.style.display = 'block';
        if(addAmountInput) addAmountInput.focus();
    }

    function closeAddFundsModal() {
        if (!addFundsModal) return;
        addFundsModal.style.display = 'none';
        currentUserIdForFunds = null;
    }

    function showAddFundsError(message) {
        if (!addFundsErrorDiv || !addFundsErrorMsg) return;
        addFundsErrorMsg.textContent = message || 'An unknown error occurred.';
        addFundsErrorDiv.style.display = 'block';
    }

    function hideAddFundsError() {
        if (!addFundsErrorDiv) return;
        addFundsErrorDiv.style.display = 'none';
        addFundsErrorMsg.textContent = '';
    }
     window.addEventListener('click', function(event) {
        if (event.target == addFundsModal) {
            closeAddFundsModal();
        }
        if (event.target == authModal) {
             closeModal();
        }
    });


    if (addFundsForm) {
        addFundsForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            hideAddFundsError();
            addFundsSubmitBtn.disabled = true;
            const amount = addAmountInput.value;
            if (!amount || parseFloat(amount) <= 0) {
                showAddFundsError('Please enter a valid positive amount.');
                addFundsSubmitBtn.disabled = false;
                return;
            }
             if (!currentUserIdForFunds) {
                showAddFundsError('User information is missing. Please reload the page.');
                 addFundsSubmitBtn.disabled = false;
                return;
            }


            const url = `/api/balance/additions?user_id=${currentUserIdForFunds}&amount=${amount}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    closeAddFundsModal();
                    window.location.reload();
                } else {
                    let errorDetail = 'Failed to add funds.';
                    try {
                         const errorData = await response.json();
                         errorDetail = errorData.detail || `Server error (${response.status})`;
                    } catch (e) {
                        console.error("Could not parse error response:", e);
                        errorDetail = `Server responded with status ${response.status}`;
                    }
                    showAddFundsError(errorDetail);
                }
            } catch (error) {
                console.error('Add Funds Fetch Error:', error);
                showAddFundsError('A network error occurred. Please try again.');
            } finally {
                 addFundsSubmitBtn.disabled = false;
            }
        });
    }
    function goBack() {
        window.history.back();
    }


</script>
</body>
</html>